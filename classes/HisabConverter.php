<?php
declare(strict_types=1);

namespace SpAnjaan\NepaliUnicode\Classes;

/**
 * HisabConverter
 *
 * Converts Hisab-encoded text to Unicode Nepali.
 */
final class HisabConverter
{
    // Full character map (Hisab → Unicode)
    protected static array $charMap = [
        // --- Top row symbols ---
        "!" => "ज्ञ", "\"" => "ू", "#" => "घ", "$" => "द्ध", "%" => "छ",
        "&" => "ठ", "'" => "ु", "(" => "ढ", ")" => "ण्", "*" => "ड",
        "+" => "ं", "," => ",", "-" => "(", "." => "।", "/" => "र",

        // --- Numbers 0-9 ---
        "0" => "०", "1" => "१", "2" => "२", "3" => "३", "4" => "४",
        "5" => "५", "6" => "६", "7" => "७", "8" => "८", "9" => "९",

        // --- Capital letters ---
        "A" => "ब्", "B" => "द्य", "C" => "ऋ", "D" => "म्", "E" => "भ्",
        "F" => "ँ", "G" => "न्", "H" => "ज्", "I" => "क्ष्", "J" => "व्",
        "K" => "प्", "L" => "ी", "M" => "ः", "N" => "ल्", "O" => "इ",
        "P" => "ए", "Q" => "त्त", "R" => "च्", "S" => "क्", "T" => "त्",
        "U" => "ग्", "V" => "ख्", "W" => "ध्", "X" => "ह्", "Y" => "थ्",
        "Z" => "श्",

        // --- Lowercase letters ---
        "a" => "ब", "b" => "द", "c" => "अ", "d" => "म", "e" => "भ",
        "f" => "ा", "g" => "न", "h" => "ज", "i" => "ष्", "j" => "व",
        "k" => "प", "l" => "ि", "n" => "ल", "o" => "य", "p" => "उ",
        "q" => "त्र", "r" => "च", "s" => "क", "t" => "त", "u" => "ग",
        "v" => "ख", "w" => "ध", "x" => "ह", "y" => "थ", "z" => "श",

        // --- Special symbols / punctuation ---
        ":" => "स्", ";" => "स", "<" => "?", "=" => ".", ">" => "श्र",
        "?" => "रु", "@" => "द्द", "[" => "ृ", "\\" => "्", "]" => "े",
        "^" => "ट", "_" => ")", "`" => "ञ", "|" => "्र", "}" => "ै",
        "~" => "ञ्", "¡" => "ज्ञ्", "¢" => "द्घ", "£" => "घ्", "¥" => "र्‍",
        "§" => "ट्ट", "©" => "र", "«" => "्र", "°" => "ङ्ढ", "±" => "+",
        "´" => "झ", "¶" => "ठ्ठ", "¿" => "रू", "Å" => "हृ", "Æ" => "”",
        "Ë" => "ङ्ग", "Ì" => "न्न", "Í" => "ङ्क", "Î" => "ङ्ख", "Ò" => "¨",
        "Ö" => "=", "×" => "×", "Ø" => "्य", "Ù" => ";", "Ú" => "’",
        "Û" => "!", "Ü" => "%", "Ý" => "ट्ठ", "ß" => "द्म", "å" => "द्व",
        "æ" => "“", "ç" => "ॐ", "÷" => "/", "‰" => "झ्", "‹" => "ङ्घ",
        "˜" => "ऽ", "›" => "द्र", "‘" => "ॅ", "…" => "‘", "„" => "ध्र"
    ];

    protected static array $postRules = [
        ['्ा', ''], ['(त्र|त्त)([^उभप]+?)m', '$1m$2'], ['त्रm', 'क्र'], ['त्तm', 'क्त'],
        ['([^उभप]+?)m', 'm$1'], ['उm', 'ऊ'], ['भm', 'झ'], ['पm', 'फ'], ['इ{', 'ई'],
        ['ि((.्)*[^्])', '$1ि'], ['(.[ािीुूृेैोौंःँ]*?){', '{$1'], ['((.्)*){', '{$1'],
        ['{', 'र्'], ['([ाीुूृेैोौंःँ]+?)(्(.्)*[^्])', '$2$1'], ['्([ाीुूृेैोौंःँ]+?)((.्)*[^्])', '्$2$1'],
        ['([ंँ])([ािीुूृेैोौः]*)', '$2$1'], ['ँँ', 'ँ'], ['ंं', 'ं'], ['ेे', 'े'], ['ैै', 'ै'],
        ['ुु', 'ु'], ['ूू', 'ू'], ['^ः', ':'], ['टृ', 'ट्ट'], ['ेा', 'ाे'], ['ैा', 'ाै'],
        ['अाे', 'ओ'], ['अाै', 'औ'], ['अा', 'आ'], ['एे', 'ऐ'], ['ाे', 'ो'], ['ाै', 'ौ'],
    ];

    private static function safePregReplace(string $pattern, string $replacement, string $subject): string
    {
        $result = preg_replace($pattern, $replacement, $subject);
        return $result === null ? $subject : $result;
    }

    public static function convert(string $text): string
    {
        $output = strtr($text, self::$charMap);
        foreach (self::$postRules as $rule) {
            $output = self::safePregReplace('#' . $rule[0] . '#u', $rule[1], $output);
        }
        return $output;
    }

    public static function getCharMap(): array
    {
        return self::$charMap;
    }

    public static function getPostRules(): array
    {
        return self::$postRules;
    }
}
